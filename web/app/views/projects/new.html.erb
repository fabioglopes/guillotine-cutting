<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <%= link_to projects_path, class: "text-indigo-600 hover:text-indigo-800 inline-flex items-center" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Voltar
    <% end %>
    <h1 class="text-4xl font-bold text-gray-900 mt-4">Novo Projeto</h1>
    <p class="text-gray-600 mt-2">Crie um novo projeto de otimiza√ß√£o de cortes</p>
  </div>

  <div class="bg-white rounded-lg shadow-sm p-6" data-controller="project-form" data-project-form-sheet-index-value="1000" data-project-form-piece-index-value="1000">
    <%= form_with model: @project, class: "space-y-6" do |f| %>
      <!-- Errors -->
      <% if @project.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h3 class="text-sm font-medium text-red-800 mb-2">
            <%= pluralize(@project.errors.count, "erro") %> impediu que o projeto fosse salvo:
          </h3>
          <ul class="list-disc list-inside text-sm text-red-700">
            <% @project.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Informa√ß√µes B√°sicas -->
      <div class="border-b border-gray-200 pb-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Informa√ß√µes B√°sicas</h2>
        
        <div class="space-y-4">
          <div>
            <%= f.label :name, "Nome do Projeto *", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_field :name, required: true, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent", placeholder: "Ex: Arm√°rio de Cozinha" %>
          </div>

          <div>
            <%= f.label :description, "Descri√ß√£o", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_area :description, rows: 3, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent", placeholder: "Descri√ß√£o opcional do projeto..." %>
          </div>

          <div class="space-y-4">
            <!-- Linha 1: Campos num√©ricos -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <%= f.label :cutting_width, "Espessura do Corte (mm)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.number_field :cutting_width, value: 3, min: 1, step: 0.1, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" %>
                <p class="text-xs text-gray-500 mt-1">Espessura do corte da serra (padr√£o: 3mm)</p>
              </div>

              <div>
                <%= f.label :thickness, "Espessura da Chapa (mm)", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.number_field :thickness, step: 0.1, min: 0.1, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent", placeholder: "Ex: 15" %>
                <p class="text-xs text-gray-500 mt-1">
                  <strong>Obrigat√≥rio</strong> quando usar invent√°rio. Filtra chapas com essa espessura.
                </p>
              </div>
            </div>

            <!-- Linha 2: Checkboxes e Select -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Permitir Rota√ß√£o</label>
                <div class="flex items-center h-10">
                  <%= f.check_box :allow_rotation, checked: true, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
                  <%= f.label :allow_rotation, "Sim, permitir rota√ß√£o de pe√ßas", class: "ml-2 text-sm text-gray-700" %>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">üì¶ Origem das Chapas</label>
                <div class="flex items-center h-10">
                  <%= f.check_box :use_inventory, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
                  <%= f.label :use_inventory, "Usar invent√°rio", class: "ml-2 text-sm text-gray-700" %>
                </div>
              </div>
            </div>

            <!-- Linha 3: Algoritmo de Otimiza√ß√£o -->
            <div>
              <%= f.label :optimization_algorithm, "üßÆ Algoritmo de Otimiza√ß√£o", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.select :optimization_algorithm, 
                [
                  ['Two-Stage Guillotine (USP) - Recomendado', 'two_stage_guillotine'],
                  ['Raster Point DP (UNICAMP) - Experimental', 'raster_point_dp'],
                  ['Cutting Optimizer (Padr√£o) - R√°pido', 'cutting_optimizer']
                ],
                {},
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              %>
              <p class="text-xs text-gray-500 mt-1">
                <strong>Two-Stage:</strong> Minimiza cortes guilhotina (melhor para marcenaria) |
                <strong>Raster Point:</strong> Usa pontos inteligentes de corte |
                <strong>Padr√£o:</strong> Mais r√°pido, boa efici√™ncia
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div>
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button type="button" data-project-form-target="uploadTab" data-action="click->project-form#switchToUpload" class="border-b-2 border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 font-medium text-sm">
              üì§ Upload de Arquivo
            </button>
            <button type="button" data-project-form-target="manualTab" data-action="click->project-form#switchToManual" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 font-medium text-sm">
              ‚úèÔ∏è Configurar Manualmente
            </button>
          </nav>
        </div>

        <!-- Upload Tab Content -->
        <div data-project-form-target="uploadContent" class="py-6">
          <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-400 transition-colors">
            <%= f.label :input_file, class: "cursor-pointer" do %>
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="mt-4 text-sm text-gray-600">
                <span class="font-semibold text-indigo-600">Clique para fazer upload</span> ou arraste e solte
              </p>
              <p class="mt-2 text-xs text-gray-500">YAML ou STEP (.yml, .yaml, .step, .stp)</p>
              <%= f.file_field :input_file, accept: ".yml,.yaml,.step,.stp", class: "hidden", data: { action: "change->project-form#handleFileUpload" } %>
            <% end %>
          </div>
          <div data-project-form-target="fileName" class="mt-2 text-sm text-gray-600"></div>
          
          <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
              <strong>üí° Dica:</strong> Voc√™ pode fazer upload de um arquivo YAML configurado ou um arquivo STEP exportado de CAD (OnShape, SolidWorks, Fusion 360, etc.)
            </p>
          </div>
        </div>

        <!-- Manual Tab Content -->
        <div data-project-form-target="manualContent" class="py-6 hidden">
          <!-- Chapas -->
          <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Chapas Dispon√≠veis</h3>
              <button type="button" data-action="click->project-form#addSheet" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                + Adicionar Chapa
              </button>
            </div>
            
            <div data-project-form-target="sheetsContainer" class="space-y-4">
              <%= f.fields_for :sheets do |sheet_fields| %>
                <%= render 'sheet_fields', f: sheet_fields %>
              <% end %>
            </div>
          </div>

          <!-- Pe√ßas -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Pe√ßas Necess√°rias</h3>
              <button type="button" data-action="click->project-form#addPiece" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                + Adicionar Pe√ßa
              </button>
            </div>
            
            <div data-project-form-target="piecesContainer" class="space-y-4">
              <%= f.fields_for :pieces do |piece_fields| %>
                <%= render 'piece_fields', f: piece_fields %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
        <%= link_to "Cancelar", projects_path, class: "bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg transition duration-200" %>
        <%= f.submit "Criar Projeto", class: "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Templates for nested forms (hidden) -->
<template data-project-form-target="sheetTemplate">
  <%= form_with model: @project, url: "" do |f| %>
    <%= f.fields_for :sheets, Sheet.new, child_index: 'NEW_SHEET_RECORD' do |sheet_fields| %>
      <%= render 'sheet_fields', f: sheet_fields %>
    <% end %>
  <% end %>
</template>

<template data-project-form-target="pieceTemplate">
  <%= form_with model: @project, url: "" do |f| %>
    <%= f.fields_for :pieces, Piece.new, child_index: 'NEW_PIECE_RECORD' do |piece_fields| %>
      <%= render 'piece_fields', f: piece_fields %>
    <% end %>
  <% end %>
</template>
