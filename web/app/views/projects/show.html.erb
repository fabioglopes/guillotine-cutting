<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8">
    <%= link_to projects_path, class: "text-indigo-600 hover:text-indigo-800 inline-flex items-center mb-4" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Voltar
    <% end %>
    
    <div class="flex justify-between items-start">
      <div>
        <div class="flex items-center gap-3">
          <h1 class="text-4xl font-bold text-gray-900"><%= @project.name %></h1>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= status_badge_class(@project.status) %>">
            <%= status_icon(@project.status) %> <%= status_text(@project.status) %>
          </span>
        </div>
        <% if @project.description.present? %>
          <p class="text-gray-600 mt-2"><%= @project.description %></p>
        <% end %>
      </div>
      
      <div class="flex gap-2 flex-wrap">
        <% if @project.optimized? && !@project.cut_completed? %>
          <%= button_to mark_cut_completed_project_path(@project), method: :post, 
              data: { turbo_confirm: "Confirmar que o projeto foi cortado?\n\n" + (@project.use_inventory? ? "‚ö†Ô∏è Isso consumir√° as chapas do invent√°rio." : "Isso marcar√° o projeto como conclu√≠do.") },
              class: "bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center gap-2" do %>
            ‚úÇÔ∏è Marcar como Cortado
          <% end %>
        <% elsif @project.cut_completed? %>
          <div class="flex gap-2 items-center">
            <span class="bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg flex items-center gap-2">
              ‚úÖ Cortado em <%= @project.cut_completed_at.strftime('%d/%m/%Y √†s %H:%M') %>
            </span>
            <%= button_to unmark_cut_completed_project_path(@project), method: :post,
                data: { turbo_confirm: "Desmarcar este projeto como cortado?\n\n" + (@project.use_inventory? ? "üîÑ As chapas ser√£o devolvidas ao invent√°rio." : "Isso reverter√° o status para n√£o cortado.") },
                class: "bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center gap-2" do %>
              üîÑ Cancelar Corte
            <% end %>
          </div>
        <% end %>
        <%= link_to edit_project_path(@project), class: "bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg transition duration-200" do %>
          ‚úèÔ∏è Editar
        <% end %>
        <%= button_to project_path(@project), method: :delete, data: { turbo_confirm: "Tem certeza que deseja deletar este projeto?" }, class: "bg-red-100 hover:bg-red-200 text-red-700 font-bold py-2 px-4 rounded-lg transition duration-200" do %>
          üóëÔ∏è Deletar
        <% end %>
      </div>
    </div>
  </div>

  <!-- Status Actions -->
  <% if @project.status == 'draft' || @project.status == 'error' %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-lg font-medium text-yellow-800">Projeto n√£o otimizado</h3>
          <p class="mt-1 text-sm text-yellow-700">Este projeto ainda n√£o foi processado. Clique no bot√£o abaixo para iniciar a otimiza√ß√£o.</p>
          <div class="mt-4">
            <%= button_to "‚ñ∂Ô∏è Processar Otimiza√ß√£o", optimize_project_path(@project), method: :post, class: "bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200" %>
          </div>
        </div>
      </div>
    </div>
  <% elsif @project.status == 'pending' || @project.status == 'processing' %>
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
      <div class="flex items-center">
        <svg class="animate-spin h-6 w-6 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div>
          <h3 class="text-lg font-medium text-blue-800">Processando...</h3>
          <p class="text-sm text-blue-700">A otimiza√ß√£o est√° em andamento. Esta p√°gina ser√° atualizada automaticamente.</p>
        </div>
      </div>
    </div>
    <meta http-equiv="refresh" content="3">
  <% end %>

  <!-- Project Details -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Configuration -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">‚öôÔ∏è Configura√ß√£o</h2>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-500">Origem das Chapas</dt>
          <dd class="text-gray-900 font-medium">
            <% if @project.use_inventory? %>
              üì¶ Invent√°rio
            <% else %>
              ‚úèÔ∏è Manual
            <% end %>
          </dd>
        </div>
        <div>
          <dt class="text-gray-500">Espessura do Corte</dt>
          <dd class="text-gray-900 font-medium"><%= @project.cutting_width %>mm</dd>
        </div>
        <div>
          <dt class="text-gray-500">Rota√ß√£o de Pe√ßas</dt>
          <dd class="text-gray-900 font-medium"><%= @project.allow_rotation ? "‚úÖ Permitida" : "‚ùå N√£o permitida" %></dd>
        </div>
        <div>
          <dt class="text-gray-500">Modo de Otimiza√ß√£o</dt>
          <dd class="text-gray-900 font-medium">
            <%= @project.guillotine_mode ? "üî™ Guilhotina" : "üìê Normal" %>
          </dd>
        </div>
        <div>
          <dt class="text-gray-500">Criado em</dt>
          <dd class="text-gray-900 font-medium"><%= l(@project.created_at, format: :long) %></dd>
        </div>
      </dl>
    </div>

    <!-- Sheets -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <% if @project.use_inventory? %>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">
          üì¶ Chapas do Invent√°rio 
          <span class="text-sm font-normal text-gray-500">(Dispon√≠veis)</span>
        </h2>
        <div class="space-y-2 text-sm max-h-48 overflow-y-auto">
          <% InventorySheet.available.order(:label).each do |inv_sheet| %>
            <div class="flex justify-between items-start p-2 bg-indigo-50 rounded border border-indigo-100">
              <div class="flex-1">
                <p class="font-medium text-gray-900"><%= inv_sheet.label %></p>
                <p class="text-gray-500 text-xs">
                  <%= inv_sheet.width %> √ó <%= inv_sheet.height %>mm 
                  ‚Ä¢ <%= inv_sheet.thickness %>mm
                  <% if inv_sheet.material.present? %>
                    ‚Ä¢ <%= inv_sheet.material %>
                  <% end %>
                </p>
              </div>
              <div class="text-right">
                <span class="text-gray-600 font-medium">√ó<%= inv_sheet.available_quantity %></span>
                <p class="text-xs text-gray-400">de <%= inv_sheet.quantity %></p>
              </div>
            </div>
          <% end %>
          <% if InventorySheet.available.none? %>
            <p class="text-gray-500 text-center py-4">
              Nenhuma chapa dispon√≠vel no invent√°rio
            </p>
          <% end %>
        </div>
      <% else %>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">üìã Chapas (<%= @project.sheets.count %>)</h2>
        <div class="space-y-2 text-sm max-h-48 overflow-y-auto">
          <% @project.sheets.each do |sheet| %>
            <div class="flex justify-between items-start p-2 bg-gray-50 rounded">
              <div>
                <p class="font-medium text-gray-900"><%= sheet.label %></p>
                <p class="text-gray-500"><%= sheet.width %> √ó <%= sheet.height %>mm</p>
              </div>
              <span class="text-gray-600">√ó<%= sheet.quantity %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Pieces -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">üî≤ Pe√ßas (<%= @project.pieces.count %>)</h2>
      <div class="space-y-2 text-sm max-h-48 overflow-y-auto">
        <% @project.pieces.each do |piece| %>
          <div class="flex justify-between items-start p-2 bg-gray-50 rounded">
            <div>
              <p class="font-medium text-gray-900"><%= piece.label %></p>
              <p class="text-gray-500"><%= piece.width %> √ó <%= piece.height %>mm</p>
            </div>
            <span class="text-gray-600">√ó<%= piece.quantity %></span>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Inventory Usage (if applicable) -->
    <% if @project.use_inventory? && @project.project_inventory_usages.any? %>
      <div class="bg-white rounded-lg shadow-sm p-6 border border-indigo-200">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">üì¶ Chapas do Invent√°rio Utilizadas</h2>
        <div class="space-y-2 text-sm">
          <% @project.project_inventory_usages.includes(:inventory_sheet).each do |usage| %>
            <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg border border-indigo-100">
              <div class="flex-1">
                <p class="font-medium text-gray-900"><%= usage.inventory_sheet.label %></p>
                <p class="text-gray-500 text-xs">
                  <%= usage.inventory_sheet.width %> √ó <%= usage.inventory_sheet.height %>mm 
                  ‚Ä¢ <%= usage.inventory_sheet.thickness %>mm
                  <% if usage.inventory_sheet.material.present? %>
                    ‚Ä¢ <%= usage.inventory_sheet.material %>
                  <% end %>
                </p>
              </div>
              <div class="text-right ml-4">
                <span class="text-lg font-bold text-indigo-600">√ó<%= usage.quantity_used %></span>
                <% if @project.cut_completed? %>
                  <p class="text-xs text-green-600 font-medium">‚úÖ Consumidas</p>
                <% else %>
                  <p class="text-xs text-yellow-600 font-medium">‚è≥ Reservadas</p>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        
        <% unless @project.cut_completed? %>
          <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
            <p class="text-xs text-yellow-800">
              ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Estas chapas ser√£o consumidas do invent√°rio quando voc√™ marcar o projeto como "Cortado".
            </p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Results Section -->
  <% if @project.optimized? %>
    <!-- Statistics -->
    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-sm p-6 border border-green-200 mb-8">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">üìä Resultados da Otimiza√ß√£o</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <p class="text-sm text-gray-500">Chapas Utilizadas</p>
          <p class="text-3xl font-bold text-gray-900"><%= @project.sheets_used %></p>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <p class="text-sm text-gray-500">Pe√ßas Cortadas</p>
          <p class="text-3xl font-bold text-gray-900"><%= @project.pieces_placed %> / <%= @project.pieces_total %></p>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <p class="text-sm text-gray-500">Efici√™ncia</p>
          <p class="text-3xl font-bold text-green-600"><%= @project.efficiency %>%</p>
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm">
          <p class="text-sm text-gray-500">N√£o Alocadas</p>
          <p class="text-3xl font-bold <%= @project.pieces_total - @project.pieces_placed > 0 ? 'text-red-600' : 'text-gray-900' %>">
            <%= @project.pieces_total - @project.pieces_placed %>
          </p>
        </div>
      </div>
    </div>

    <!-- Download Buttons -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">üì• Downloads</h2>
      <div class="flex flex-wrap gap-3">
        <% if @result_files.any? { |f| f.filename.to_s == 'print.html' } %>
          <%= link_to download_file_project_path(@project, filename: 'print.html'), class: "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 inline-flex items-center" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
            </svg>
            üñ®Ô∏è Vers√£o para Impress√£o (HTML)
          <% end %>
        <% end %>
        
        <% if @result_files.any? { |f| f.filename.to_s == 'index.html' } %>
          <%= link_to download_file_project_path(@project, filename: 'index.html'), class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 inline-flex items-center" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            üìÑ Visualiza√ß√£o HTML
          <% end %>
        <% end %>
      </div>
      
      <div class="mt-4">
        <p class="text-sm text-gray-600 mb-2"><strong>SVGs Individuais:</strong></p>
        <div class="flex flex-wrap gap-2">
          <% @result_files.select { |f| f.filename.to_s.end_with?('.svg') }.each do |svg_file| %>
            <%= link_to download_file_project_path(@project, filename: svg_file.filename.to_s), class: "bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-200 text-sm" do %>
              üìä <%= svg_file.filename %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- SVG Preview -->
    <div class="space-y-6">
      <h2 class="text-2xl font-semibold text-gray-900">üé® Visualiza√ß√£o dos Layouts</h2>
      <% @result_files.select { |f| f.filename.to_s.end_with?('.svg') }.each do |svg_file| %>
        <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
          <h3 class="text-lg font-medium text-gray-900 mb-4"><%= svg_file.filename %></h3>
          <div class="border border-gray-300 rounded-lg p-4 bg-gray-50 overflow-auto">
            <%= svg_file.download.force_encoding('UTF-8').html_safe %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
